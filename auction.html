<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <link rel="stylesheet" type="text/css" href="css/number/number.css" />
    </head>
    <body>
        <div class="auctionA" id="big"></div>
        <br />
        <div class="auctionB" id="big"></div>
        <br />
        <div class="auctionB1" id="big"></div>
        <br />
        
        <div class="auctionC" id="big"></div>
        <br />
        
        <script src="js/lib/jquery-1.11.1.js" type="text/javascript"></script>
        <script src="js/lib/jquery-ui.js" type="text/javascript"></script>
        <script src="js/jquery.numbers.js" type="text/javascript"></script>
        <script src="js/jquery.auction.js" type="text/javascript"></script>
        <script type="text/javascript">
            $(function() {
                $('.auctionA').auctionA({ // 匀速下跌式拍卖
                    start: 2500.00,
                    totalTime: 1080000,
                    currentTime: 0,
                    interval: 1000, 
                    cutDown: 1.00,
                    
                    numbers: {
                        rootClass: "numbers",
                        numberH: 50,
                        totalSize: 15
                        // numberSize: 10
                        // value: "￥56,789.12"
                    }
                });
                
                $('.auctionB').auctionB({ // 加速下跌式拍卖
                    type: 1,
                    start: 2500.00,
                    totalTime: 1080000,
                    currentTime: 0,
                    
                    interval: 1000, 
                    
                    minCutDown: 0.30,
                    maxCutDown: 2.70,
                    CDchangeTimes: 10,
                    
                    numbers: {
                        // rootClass: "numbers"
                    }
                });
                
                $('.auctionB1').auctionB({ // 减速下跌式拍卖
                    type: -1,
                    start: 2500.00,
                    totalTime: 1080000,
                    currentTime: 0,
                    
                    interval: 1000, 
                    
                    minCutDown: 0.30,
                    maxCutDown: 2.70,
                    CDchangeTimes: 10,
                    
                    numbers: {
                        rootClass: "numbers numbers-small",
                        numberH: 41,
                        totalSize: 15, 
                        numberSize: 11
                    }
                });
                
            });
            
            
            $(function() {
                // simulate data
                var start = 2500000;
                var interval = 1000;
                var n = start;
                var steps = [{time: 0, price: n}]; // steps comes from backend
                for(var i = 0; i < 1080; i++) {
                    var c = -(i + 1);
                    n += c;
                    steps[i+1] = {time: (i + 1) * 1000, price: n};
                }
            
                console.log(JSON.stringify(steps));
                // simulate data end
                
                var index = 0;
                var a = $('.auctionC').auctionC({ // 按步下跌, 从server动态拿数据 {time: 20000,  price: 2450}]
                    // $('.auctionC').auctionC('updateSteps', [{time: 20000,  price: 2450}]).auctionC('setTime', 1079000);
                    refresh: function(e, data) {
                        var left = a.auctionC('getLeftStepsCount');
                        if(left <= 5) { // 少于5条开始拿数据
                            // ajax to get lastest values
                            function callback(r) { // {currentTime: 1079000, steps: [{s: 3, r: 2492}, stopped: false, stopAt:1080]}
                                console.log('Get new steps: ' + JSON.stringify(r.steps));
                                index += 10;
                                a.auctionC('updateSteps', r.steps);
                                var stopped = !!r.stopped;
                                if(stopped) {
                                    a.auctionC('stop', r.stopAt);
                                } else if(!isNaN(r.currentTime)) { //sync
                                    a.auctionC('setTime', Number(r.currentTime));
                                }
                            }
                            
                            var slice = steps.slice(index, index + 10);
                            var stopped = (index + 10) === steps.length - 1;
                            if(stopped) {
                                var at = 12415125;
                                console.log('stopped!! at ' + at);
                            }
                            callback({
                                stopped: stopped,
                                stopAt: at,
                                steps: slice
                            });
                        }
                    },
                    
                    start: start,
                    // totalTime: 1080000,
                    currentTime: 0,
                    
                    interval: interval
                });
                // .auctionC('updateSteps', steps);
                
            });
        </script>
</html>